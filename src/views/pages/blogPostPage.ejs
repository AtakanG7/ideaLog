<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" type="text/css" href="src/js/jquery.notebook.css">
    <title>Create Blog Post</title>
</head>
<body>
    <div class="container my-5">
        <h1 class="mb-4">Create Blog Post</h1>
        <form id="blogForm" action="/blogs/" method="POST">
                <label for="title">Title</label>
                <input id="title" name="title" type="text" class="form-control" required>
                <label for="description">Description</label>
                <input id="description" name="description" type="text" class="form-control" required>
                <label for="authorName">Author Name</label>
                <input id="authorName" name="authorName" type="text" class="form-control" required>
                <label for="status">Status</label>
                <select id="status" name="status" class="form-control">
                    <option value="draft">Draft</option>
                    <option value="review">Review</option>
                    <option value="published">Published</option>
                </select>
                <label for="content">Content</label>
                <input id="content" name="content" >
            <button type="submit" class="btn btn-primary mt-3">Create Blog Post</button>
        </form>
    </div>

    <div class="block-selection" style="display: none;"></div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.13.0/jquery-ui.min.js"></script>
    <script src="src/js/jquery.notebook.js"></script>
    <script>
        $(document).ready(function(){

            $('.blog-editor').notebook();

            // Save content to hidden input before submitting form
            $('#blogForm').on('submit', function() {
                var content = $('#content-editor').html();
                $('#content').val(content);
            });

            var editor = $('.blog-editor');
            var blockSelection = $('.block-selection');
            var currentSelection = null;

            // Load content from localStorage on page load
            var storedContent = localStorage.getItem('blogContent');
            if (storedContent) {
                editor.html(storedContent);
            }

            // Save content to localStorage when the page is unloaded
            $(window).on('beforeunload', function() {
                var content = editor.html();
                localStorage.setItem('blogContent', content);
            });

            // Show initial message
            editor.html('<div class="placeholder">Hello, please type / to add a block.</div>');

            function addBlock(type, content = '') {
                var block = $('<div class="block d-flex flex-column" tabindex="0"></div>');
                var input;
                var actions = $('<div class="block-actions mt-2"></div>');
                var deleteBtn = $('<button class="btn btn-sm btn-danger">Delete</button>');
                var blockHandle = $('<div class="block-handle"><i class="fas fa-arrows-alt"></i></div>');

                switch (type) {
                    case 'text':
                        input = $('<div class="form-control" contenteditable="true"></div>');
                        input.text(content || 'Enter text here...');
                        break;
                    case 'code':
                        input = $('<pre class="form-control code-block" contenteditable="true"></pre>');
                        input.text(content || 'Enter code here...');
                        break;
                    case 'image':
                        input = $('<div class="input-group"><div class="custom-file"><input type="file" name="image" class="custom-file-input" id="inputGroupFile"><label class="custom-file-label" for="inputGroupFile">Choose file</label></div></div>');
                        break;
                }

                deleteBtn.click(function() {
                    block.remove();
                });

                actions.append(blockHandle, deleteBtn);
                block.append(input, actions);

                if (currentSelection && currentSelection.length > 0) {
                    currentSelection.replaceWith(block);
                } else {
                    editor.append(block);
                }

                currentSelection = null;
                makeBlocksSortable();
                adjustCodeBlockHeight();
            }

            function makeBlocksSortable() {
                try {
                    $('.blog-editor').sortable({
                        handle: '.block-handle',
                        update: function(event, ui) {
                            // Update block order based on the new position
                        }
                    });
                } catch (err) {
                    console.log('Error making blocks sortable: ', err);
                    $('.blog-editor').sortable('destroy');
                    makeBlocksSortable();
                }
            }

            function adjustCodeBlockHeight() {
                $('.code-block').each(function() {
                    $(this).height($(this)[0].scrollHeight);
                });
            }

            editor.on('keyup', function(e) {
                if (e.key === '/') {
                    e.preventDefault();
                    var selection = window.getSelection();
                    var range = selection.getRangeAt(0);
                    var blockTypes = ['text', 'code', 'image'];
                    var selectionRect = range.getBoundingClientRect();
                    var selectionX = selectionRect.left + selectionRect.width / 2;
                    var selectionY = selectionRect.top + selectionRect.height + window.pageYOffset;

                    selection.removeAllRanges();

                    blockSelection.empty();
                    blockTypes.forEach(function(type) {
                        var option = $('<div class="block-option">' + type + '</div>');
                        option.click(function() {
                            addBlock(type);
                            blockSelection.hide();
                        });
                        blockSelection.append(option);
                    });

                    blockSelection.css({
                        left: selectionX + 'px',
                        top: selectionY + 'px',
                        display: 'block'
                    });
                }
            });

            $(document).click(function(e) {
                if (!blockSelection.is(e.target) && blockSelection.has(e.target).length === 0) {
                    blockSelection.hide();
                }
            });

            editor.on('click', function() {
                $('.placeholder').hide();
            });

            makeBlocksSortable();
            adjustCodeBlockHeight();
        });
    </script>
</body>
</html>
